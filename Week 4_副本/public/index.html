<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8">
    	<meta name="viewport" content="width=device-width, initial-scale=1.0">
    	<title>Minion-Themed Chat Window</title>
    	<link rel="stylesheet" href="style.css">
		
		<script type="text/javascript" src="/socket.io/socket.io.js"></script>
		<script type="text/javascript">

			window.addEventListener('load', function() {

				let video = document.getElementById('thevideo');
				let thecanvas = document.getElementById('thecanvas');
				let thecontext = thecanvas.getContext("2d");

				// Constraints - what do we want?
				let constraints = { audio: true, video: true }

				// Prompt the user for permission, get the stream
				navigator.mediaDevices.getUserMedia(constraints).then(function(stream) {
					/* Use the stream */
					
					// Attach to our video object
					video.srcObject = stream;
					
					// Wait for the stream to load enough to play
					video.onloadedmetadata = function(e) {
						video.play();
						setInterval(function() {
							thecontext.drawImage(video,0,0,thecanvas.width,thecanvas.height);
							console.log(thecanvas.toDataURL());
							socket.emit('v', thecanvas.toDataURL())
						}, 1000);
					};
				})
				.catch(function(err) {
					/* Handle the error */
					alert(err);  
				});				
			});






			let submit;
			window.addEventListener('load', function() {
				submit = document.getElementById('submit');
				submit.addEventListener('click', function() {
					let data = {
						message: document.getElementById('message').value,
						color: document.getElementById('color').value
					};
					socket.emit('chatmessage', data);
				})

				document.addEventListener('click', function() {
					socket.emit('click', {});
				})

			})


			var socket = io.connect();
			
			socket.on('connect', function() {
				console.log("Connected");
			});

			socket.on('v', function(data) {
				document.getElementById('theimage').src = data;
			});

			socket.on('click', function() {
				console.log('Got a click');
				document.body.style.backgroundColor = "#000000";
				setTimeout(function() {
					document.body.style.backgroundColor = "#ffffff";
				}, 100);
			});

			// Receive from any event
			socket.on('chatmessage', function (data) {
				console.log(data);
				let newelement = document.createElement('div');
				newelement.style.color = data.color;
				newelement.innerHTML = data.message;
				document.body.appendChild(newelement);
// 				document.getElementById('messages').innerHTML = "" + data + 
//  + "" + document.getElementById('messages').innerHTML;
			});
		
		</script>	
	</head>
 <body>

	<div class="chat-window">
		<div class="chat-image">
			<img src="minions.gif" alt="minions">
		</div>
		<div class="chat-header">Welcome to Minions Channel! Have Fun!</div>
		<div class="chat-body"></div>
		<div class="chat-footer">
			<input type="text" class="chat-input" placeholder="Let's Chat Here...">
			<input class="send-button" type="submit" value="submit" onclick="sendmessage(document.getElementById('chat-input').value);">
		</div>
		<div>
			<video id="thevideo" muted></video>
			<img id="theimage" width="800" heigh="450">
		</div>
	</div>

	<canvas id="thecanvas" width="600" height="450"></canvas>


	<script src="script.js"></script>
 </body>
</html>
